suite: services comprehensive tests
templates:
  - service.yaml
  - service-headless.yaml

tests:
  # Main service tests
  - it: renders main Service with correct configuration
    template: service.yaml
    asserts:
      - equal:
          path: kind
          value: Service
      - equal:
          path: apiVersion
          value: v1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-service
      - contains:
          path: metadata.labels
          content:
            app: RELEASE-NAME
            chart: oxy-app-0.1.13
            release: RELEASE-NAME

  - it: configures service ports correctly
    template: service.yaml
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP
      - contains:
          path: spec.ports
          content:
            port: 80
            targetPort: 3000
            protocol: TCP
            name: http
      - equal:
          path: spec.selector.app
          value: RELEASE-NAME

  # Custom service name
  - it: uses custom service name when provided
    template: service.yaml
    set:
      service.name: "custom-service-name"
    asserts:
      - equal:
          path: metadata.name
          value: custom-service-name

  # Custom service type
  - it: supports different service types
    template: service.yaml
    set:
      service.type: NodePort
    asserts:
      - equal:
          path: spec.type
          value: NodePort

  - it: supports LoadBalancer service type
    template: service.yaml
    set:
      service.type: LoadBalancer
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  # Custom ports
  - it: supports custom service port
    template: service.yaml
    set:
      service.port: 8080
      service.targetPort: 8080
    asserts:
      - contains:
          path: spec.ports
          content:
            port: 8080
            targetPort: 8080
            protocol: TCP
            name: http

  # Headless service tests
  - it: renders headless Service when enabled
    template: service-headless.yaml
    asserts:
      - equal:
          path: kind
          value: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-headless
      - equal:
          path: spec.clusterIP
          value: None
      - equal:
          path: spec.type
          value: ClusterIP
      - contains:
          path: spec.ports
          content:
            port: 80
            targetPort: 3000
            protocol: TCP
            name: http
      - equal:
          path: spec.selector.app
          value: RELEASE-NAME

  - it: does not render headless Service when disabled
    template: service-headless.yaml
    set:
      headlessService.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  # Service selector tests
  - it: configures correct selectors for services
    template: service.yaml
    asserts:
      - equal:
          path: spec.selector.app
          value: RELEASE-NAME

  - it: configures correct selectors for headless service
    template: service-headless.yaml
    asserts:
      - equal:
          path: spec.selector.app
          value: RELEASE-NAME

  # Port configuration edge cases
  - it: handles numeric targetPort correctly
    template: service.yaml
    set:
      service.targetPort: 3000
      app.port: 3000
    asserts:
      - contains:
          path: spec.ports
          content:
            targetPort: 3000

  - it: handles string targetPort correctly
    template: service.yaml
    set:
      service.targetPort: "http"
    asserts:
      - contains:
          path: spec.ports
          content:
            targetPort: "http"

  # Service labels and annotations
  - it: includes correct labels in services
    template: service.yaml
    asserts:
      - equal:
          path: metadata.labels.app
          value: RELEASE-NAME
      - equal:
          path: metadata.labels.chart
          value: oxy-app-0.1.13
      - equal:
          path: metadata.labels.release
          value: RELEASE-NAME

  - it: includes correct labels in headless service
    template: service-headless.yaml
    asserts:
      - equal:
          path: metadata.labels.app
          value: RELEASE-NAME
      - equal:
          path: metadata.labels.chart
          value: oxy-app-0.1.13
      - equal:
          path: metadata.labels.release
          value: RELEASE-NAME

  # Multiple port scenarios (edge case)
  - it: handles app port different from service targetPort
    template: service.yaml
    set:
      app.port: 3000
      service.targetPort: 8080  # Different from app.port
    asserts:
      - contains:
          path: spec.ports
          content:
            targetPort: 8080  # Should use service.targetPort

  # Service mesh compatibility
  - it: maintains compatibility with service mesh selectors
    template: service.yaml
    asserts:
      - equal:
          path: spec.selector.app
          value: RELEASE-NAME
      - notExists:
          path: spec.selector.version  # Version should not be in service selector

  - it: headless service maintains StatefulSet compatibility
    template: service-headless.yaml
    asserts:
      - equal:
          path: spec.selector.app
          value: RELEASE-NAME
      - equal:
          path: spec.clusterIP
          value: None