suite: statefulset comprehensive tests
templates:
  - statefulset.yaml
  - service-headless.yaml

tests:
  # Basic StatefulSet validation
  - it: renders StatefulSet kind with correct metadata
    asserts:
      - equal:
          path: kind
          value: StatefulSet
      - equal:
          path: apiVersion
          value: apps/v1
      - equal:
          path: metadata.name
          value: RELEASE-NAME
      - contains:
          path: metadata.labels
          content:
            app: RELEASE-NAME
            chart: oxy-app-0.1.13
            release: RELEASE-NAME
            version: v1

  # Default configuration tests
  - it: sets correct default configuration
    asserts:
      - equal:
          path: spec.serviceName
          value: RELEASE-NAME-headless
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.selector.matchLabels.app
          value: RELEASE-NAME
      - equal:
          path: spec.template.metadata.labels.app
          value: RELEASE-NAME
      - equal:
          path: spec.template.metadata.labels.version
          value: v1

  # Container configuration
  - it: sets correct container image and configuration
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: oxy-app
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/oxy-hq/oxy:"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: http
            containerPort: 3000
            protocol: TCP

  # Environment variables
  - it: sets correct default environment variables
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OXY_STATE_DIR
            value: "/workspace/oxy_data"

  # Volume mounts
  - it: sets correct volume mounts for persistence
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: workspace
            mountPath: /workspace

  # PVC template
  - it: includes correct PVC template
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.name
          value: workspace
      - equal:
          path: spec.volumeClaimTemplates[0].spec.accessModes[0]
          value: ReadWriteOnce
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 20Gi
      - equal:
          path: spec.volumeClaimTemplates[0].spec.storageClassName
          value: gp3
      - equal:
          path: spec.volumeClaimTemplates[0].spec.volumeMode
          value: Filesystem

  # Security context
  - it: applies correct security context
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000

  # Service account
  - it: uses correct service account
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: oxy-app-sa

  # Resource limits
  - it: sets correct resource requests and limits
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 250m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 512Mi
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 1000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 2Gi

  # Probes configuration
  - it: configures liveness probe correctly
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: "/"
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 3000
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 60
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.timeoutSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.failureThreshold
          value: 3

  - it: configures readiness probe correctly
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: "/"
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 3000
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.timeoutSeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 3

  # Update strategy
  - it: configures rolling update strategy
    asserts:
      - equal:
          path: spec.updateStrategy.type
          value: RollingUpdate
      - equal:
          path: spec.updateStrategy.rollingUpdate.partition
          value: 0