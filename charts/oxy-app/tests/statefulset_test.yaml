suite: statefulset tests
templates:
  - statefulset.yaml

tests:
  # =======================
  # Basic StatefulSet Tests
  # =======================

  - it: should create a StatefulSet with correct metadata
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-oxy-app
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: oxy-app
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should configure StatefulSet with correct defaults
    asserts:
      - equal:
          path: spec.serviceName
          value: RELEASE-NAME-oxy-app-headless
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.template.spec.containers[0].name
          value: oxy-app

  - it: should support replica scaling
    set:
      app:
        replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  # =======================
  # Container Configuration
  # =======================

  - it: should configure main container correctly
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/oxy-hq/oxy:0.5.16"
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            containerPort: 3000
            protocol: TCP
            name: traffic-port

  - it: should only expose main port by default
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers[0].ports
          count: 1
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: traffic-port

  - it: should support custom image configuration
    set:
      app:
        image: "custom/oxy-app"
        imageTag: "v2.0.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "custom/oxy-app:v2.0.0"

  # =======================
  # Environment Variables
  # =======================

  - it: should set default environment variables
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OXY_STATE_DIR
            value: "/workspace/oxy_data"

  - it: should allow custom database URL
    set:
      env:
        OXY_DATABASE_URL: "postgresql://user:pass@host:5432/db"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OXY_DATABASE_URL
            value: "postgresql://user:pass@host:5432/db"

  - it: should support custom environment variables from values.env
    set:
      env:
        OXY_STATE_DIR: /workspace/oxy_data
        CUSTOM_VAR_1: "value1"
        CUSTOM_VAR_2: "value2"
        LOG_LEVEL: "debug"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR_1
            value: "value1"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR_2
            value: "value2"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOG_LEVEL
            value: "debug"

  - it: should not set empty environment variables
    set:
      env:
        OXY_STATE_DIR: /workspace/oxy_data
        EMPTY_VAR: ""
        VALID_VAR: "value"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VALID_VAR
            value: "value"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: EMPTY_VAR

  - it: should not duplicate OXY_STATE_DIR or OXY_DATABASE_URL in custom env loop
    set:
      env:
        OXY_STATE_DIR: /custom/state
        OXY_DATABASE_URL: "postgresql://user:pass@host:5432/db"
        CUSTOM_VAR: "value"
    asserts:
      # Ensure OXY_STATE_DIR appears exactly once
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OXY_STATE_DIR
            value: "/custom/state"
      # Ensure OXY_DATABASE_URL appears exactly once
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OXY_DATABASE_URL
            value: "postgresql://user:pass@host:5432/db"
      # Ensure custom var is present
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR
            value: "value"

  - it: should support multiple custom environment variables with special characters
    set:
      env:
        API_KEY: "sk-1234567890abcdef"
        WEBHOOK_URL: "https://example.com/webhook"
        MAX_WORKERS: "10"
        ENABLE_FEATURE: "true"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: API_KEY
            value: "sk-1234567890abcdef"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WEBHOOK_URL
            value: "https://example.com/webhook"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MAX_WORKERS
            value: "10"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ENABLE_FEATURE
            value: "true"

  - it: should work with only custom environment variables and no special OXY vars
    set:
      env:
        MY_VAR_1: "value1"
        MY_VAR_2: "value2"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MY_VAR_1
            value: "value1"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MY_VAR_2
            value: "value2"
      # OXY_STATE_DIR should still have default fallback
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OXY_STATE_DIR
            value: "/workspace/oxy_data"

  # =======================
  # Database Configuration
  # =======================

  - it: should configure PostgreSQL database URL correctly
    set:
      database:
        postgres:
          enabled: true
      postgres:
        userDatabase:
          name:
            value: "testdb"
          user:
            value: "testuser"
          password:
            value: "testpass"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OXY_DATABASE_URL
            value: "postgresql://testuser:testpass@RELEASE-NAME-postgres.NAMESPACE.svc.cluster.local:5432/testdb"

  - it: should support groundhog2k PostgreSQL chart with custom values
    set:
      database:
        postgres:
          enabled: true
      postgres:
        userDatabase:
          name:
            value: "custom-db"
          user:
            value: "custom-user"
          password:
            value: "custom-pass"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OXY_DATABASE_URL
            value: "postgresql://custom-user:custom-pass@RELEASE-NAME-postgres.NAMESPACE.svc.cluster.local:5432/custom-db"

  - it: should use postgres fullnameOverride for service name when provided
    set:
      database:
        postgres:
          enabled: true
      postgres:
        fullnameOverride: "my-postgres"
        userDatabase:
          name:
            value: "testdb"
          user:
            value: "testuser"
          password:
            value: "testpass"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: OXY_DATABASE_URL
            value: "postgresql://testuser:testpass@my-postgres.NAMESPACE.svc.cluster.local:5432/testdb"

  # =======================
  # Init Containers
  # =======================

  - it: should not have init containers by default
    set:
      gitSync:
        enabled: false
      database:
        postgres:
          enabled: false
    asserts:
      - notExists:
          path: spec.template.spec.initContainers

  - it: should create PostgreSQL wait init container when database enabled
    set:
      database:
        postgres:
          enabled: true
      postgres:
        userDatabase:
          user:
            value: "testuser"
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 1
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: wait-for-postgres
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: "postgres:16-alpine"

  - it: should create git clone init container when git sync enabled
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 1
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: git-clone

  - it: should create both PostgreSQL and git init containers when both enabled
    set:
      database:
        postgres:
          enabled: true
      postgres:
        userDatabase:
          user:
            value: "testuser"
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 2
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: wait-for-postgres
      - equal:
          path: spec.template.spec.initContainers[1].name
          value: git-clone

  - it: should add extra init containers
    set:
      extraInitContainers:
        - name: custom-init
          image: busybox:1.36
          command: ["echo", "hello"]
    asserts:
      - lengthEqual:
          path: spec.template.spec.initContainers
          count: 1
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: custom-init

  # =======================
  # Git Sync Configuration
  # =======================

  - it: should have single container when git sync disabled
    set:
      gitSync:
        enabled: false
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 1
      - equal:
          path: spec.template.spec.containers[0].name
          value: oxy-app

  - it: should include readonly flag when git sync disabled
    set:
      gitSync:
        enabled: false
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--cloud.*"

  # =======================
  # Internal Port Tests
  # =======================

  - it: should not include internal port flags by default
    set:
      gitSync:
        enabled: false
    asserts:
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--internal-host.*"
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--internal-port.*"

  - it: should expose internal container port when internalHost is set
    set:
      app:
        internalHost: "0.0.0.0"
        internalPort: 3001
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers[0].ports
          count: 2
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            containerPort: 3000
            protocol: TCP
            name: traffic-port
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            containerPort: 3001
            protocol: TCP
            name: internal-port

  - it: should include internal port flags in command when enabled
    set:
      gitSync:
        enabled: false
      app:
        internalHost: "0.0.0.0"
        internalPort: 3001
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--internal-host 0\\.0\\.0\\.0.*"
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--internal-port 3001.*"

  - it: should support custom internal host and port
    set:
      gitSync:
        enabled: false
      app:
        internalHost: "127.0.0.1"
        internalPort: 8001
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers[0].ports
          count: 2
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            containerPort: 8001
            protocol: TCP
            name: internal-port
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--internal-host 127\\.0\\.0\\.1.*"
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--internal-port 8001.*"

  - it: should work with both git sync and internal port
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      app:
        internalHost: "0.0.0.0"
        internalPort: 3001
      persistence:
        enabled: true
    asserts:
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--cloud.*"
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--internal-host 0\\.0\\.0\\.0.*"
      - matchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--internal-port 3001.*"
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            containerPort: 3001
            protocol: TCP
            name: internal-port

  - it: should have two containers when git sync enabled (includes semantic engine)
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2
      - equal:
          path: spec.template.spec.containers[0].name
          value: oxy-app
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine

  - it: should not include readonly flag when git sync enabled
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      - notMatchRegex:
          path: spec.template.spec.containers[0].command[2]
          pattern: ".*--cloud.*"



  - it: should configure git clone init container correctly
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:test/repo.git"
      semanticEngine:
        enabled: true
        branch: "main"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: "k8s.gcr.io/git-sync/git-sync:v4.4.3"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--repo=git@github.com:test/repo.git"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--branch=main"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--one-time=true"

  # =======================
  # Git Sync Path Configuration (Subdirectory Safety)
  # =======================

  - it: should use default git-sync paths as subdirectories of mount path
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      persistence:
        enabled: true
        mountPath: "/workspace"
    asserts:
      # Init container should use subdirectories
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--root=/workspace/git"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--link=/workspace/current"


  - it: should allow custom git-sync directory names while maintaining subdirectory structure
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
        root: "myrepo"
        link: "latest"
      persistence:
        enabled: true
        mountPath: "/data"
    asserts:
      # Should append custom names to mount path
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--root=/data/myrepo"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--link=/data/latest"

  - it: should ensure git-sync paths avoid volume root to prevent lost+found conflicts
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      persistence:
        enabled: true
        mountPath: "/mnt/data"
    asserts:
      # Verify paths are NOT at volume root
      - notContains:
          path: spec.template.spec.initContainers[0].args
          content: "--root=/mnt/data"
      # Verify paths ARE in subdirectories
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--root=/mnt/data/git"
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "--link=/mnt/data/current"

  - it: should set workingDir to git link path for main container
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      persistence:
        enabled: true
        mountPath: "/workspace"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].workingDir
          value: "/workspace/current"

  - it: should set workingDir with custom link directory
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
        link: "active"
      persistence:
        enabled: true
        mountPath: "/data"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].workingDir
          value: "/data/active"

  # =======================
  # Sidecar Containers
  # =======================

  - it: should add extra sidecar containers
    set:
      extraSidecars:
        - name: monitoring
          image: prom/node-exporter:v1.6.0
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2
      - equal:
          path: spec.template.spec.containers[1].name
          value: monitoring

  - it: should work with git sync, semantic engine, and sidecars together
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      extraSidecars:
        - name: monitoring
          image: prom/node-exporter:v1.6.0
      persistence:
        enabled: true
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 3
      - equal:
          path: spec.template.spec.containers[0].name
          value: oxy-app
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine
      - equal:
          path: spec.template.spec.containers[2].name
          value: monitoring

  # =======================
  # Persistence & Volumes
  # =======================

  - it: should configure persistence correctly
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.name
          value: workspace
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 20Gi

  - it: should allow custom persistence settings
    set:
      persistence:
        size: 100Gi
        storageClassName: fast-ssd
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 100Gi
      - equal:
          path: spec.volumeClaimTemplates[0].spec.storageClassName
          value: fast-ssd

  - it: should always create workspace volume claim template
    set:
      persistence:
        enabled: false
    asserts:
      - lengthEqual:
          path: spec.volumeClaimTemplates
          count: 1
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.name
          value: workspace

  - it: should share workspace volume between containers
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
        mountPath: "/data"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: workspace
            mountPath: "/data"
      - contains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            name: workspace
            mountPath: "/data"

  - it: should have empty volumes list by default
    asserts:
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 0

  - it: should mount SSH secret when git sync enabled
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
        sshSecretName: "my-git-ssh"
      sshKey:
        privateKey: "fake-key"
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "git-clone")].volumeMounts
          content:
            name: git-ssh
            mountPath: /etc/git-secret
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: git-ssh
            secret:
              secretName: "my-git-ssh"
              defaultMode: 0400
              optional: false

  - it: should use custom SSH secret name when sshKey.secretName is set
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
        sshSecretName: "default-ssh-secret"
      sshKey:
        secretName: "custom-ssh-secret"
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: git-ssh
            secret:
              secretName: "custom-ssh-secret"
              defaultMode: 0400
              optional: false

  - it: should fall back to gitSync.sshSecretName when sshKey.secretName is empty
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
        sshSecretName: "my-git-ssh"
      sshKey:
        secretName: ""
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: git-ssh
            secret:
              secretName: "my-git-ssh"
              defaultMode: 0400
              optional: false

  # =======================
  # External Secrets
  # =======================

  - it: should mount environment secrets when specified
    set:
      externalSecrets:
        envSecretNames:
          - "app-secrets"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: env-secret-0
            secret:
              secretName: "app-secrets"
              optional: true

  # =======================
  # Resource Configuration
  # =======================

  - it: should set default resource limits and requests
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 250m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 512Mi
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 1000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 2Gi

  - it: should allow custom resource configuration
    set:
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 4Gi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 4Gi

  # =======================
  # Health Probes
  # =======================

  - it: should configure default health probes
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: "/"
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 3000
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: "/"
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 3000

  - it: should allow custom probe configuration
    set:
      livenessProbe:
        httpGet:
          path: /health
          port: 3000
        initialDelaySeconds: 10
        periodSeconds: 30
      readinessProbe:
        httpGet:
          path: /ready
          port: 3000
        initialDelaySeconds: 10
        periodSeconds: 5
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: "/health"
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 10
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: "/ready"

  # =======================
  # Security & Service Account
  # =======================

  - it: should apply security context
    set:
      securityContext:
        fsGroup: 2000
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 2000

  - it: should use correct service account
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-oxy-app

  # =======================
  # HTTP Auth Tests
  # =======================

  - it: should add HTTP auth arguments when username and password provided
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      semanticEngine:
        enabled: true
      httpAuth:
        username: "myuser"
        password: "mypass"
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "git-clone")].args
          content: "--username=myuser"
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "git-clone")].args
          content: "--password-file=/etc/git-auth/password"

  - it: should mount HTTP auth secret when username provided
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      semanticEngine:
        enabled: true
      httpAuth:
        username: "myuser"
        password: "mypass"
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "git-clone")].volumeMounts
          content:
            name: git-http-auth
            mountPath: /etc/git-auth
            readOnly: true

  - it: should create HTTP auth volume with inline password
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      semanticEngine:
        enabled: true
      httpAuth:
        username: "myuser"
        password: "mypass"
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: git-http-auth
            secret:
              secretName: RELEASE-NAME-oxy-app-http-auth
              defaultMode: 0400
              optional: false
              items:
                - key: password
                  path: password

  - it: should use custom secret name when httpAuth.secretName is provided
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      semanticEngine:
        enabled: true
      httpAuth:
        username: "myuser"
        secretName: "my-custom-secret"
        passwordKey: "myPasswordKey"
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: git-http-auth
            secret:
              secretName: my-custom-secret
              defaultMode: 0400
              optional: false
              items:
                - key: myPasswordKey
                  path: password

  - it: should not use SSH keys when HTTP auth is enabled
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      semanticEngine:
        enabled: true
      httpAuth:
        username: "myuser"
        password: "mypass"
      sshKey:
        privateKey: "fake-key"
      persistence:
        enabled: true
    asserts:
      - notContains:
          path: spec.template.spec.initContainers[?(@.name == "git-clone")].args
          content: "--ssh-key-file=/etc/git-secret/ssh"
      - notContains:
          path: spec.template.spec.initContainers[?(@.name == "git-clone")].volumeMounts
          any: true
          content:
            name: git-ssh

  - it: should add github app args/env when githubApp inline values provided
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
        githubApp:
          privateKey: "my-pem"
          applicationId: "123"
          installationId: "456"
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "git-clone")].args
          content: "--github-app-private-key-file=/etc/github-app/github_app_private_key"
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "git-clone")].env
          content:
            name: GITSYNC_GITHUB_APP_APPLICATION_ID
            value: "123"

  - it: should mount provided github app secret when secretName set
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
        githubApp:
          secretName: "my-github-app-secret"
          privateKeyKey: "my_private_key"
          applicationIdKey: "my_app_id"
          installationIdKey: "my_install_id"
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: github-app-secret
            secret:
              secretName: my-github-app-secret
              defaultMode: 0400
              optional: false

  # ================================
  # Semantic Engine Sidecar Tests
  # ================================

  - it: should not deploy semantic engine when git sync disabled
    set:
      gitSync:
        enabled: false
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 1
      - equal:
          path: spec.template.spec.containers[0].name
          value: oxy-app

  - it: should deploy semantic engine when git sync enabled
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2
      - equal:
          path: spec.template.spec.containers[0].name
          value: oxy-app
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine

  - it: should use default semantic engine image with app imageTag
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      app:
        imageTag: "0.3.5"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].image
          value: "ghcr.io/oxy-hq/oxy-semantic-engine:0.3.5"
      - equal:
          path: spec.template.spec.containers[1].imagePullPolicy
          value: "IfNotPresent"

  - it: should use custom semantic engine image
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
        image: "custom-registry.io/my-semantic-engine"
        imageTag: "1.0.0"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].image
          value: "custom-registry.io/my-semantic-engine:1.0.0"

  - it: should use semantic engine imageTag over app imageTag
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      app:
        imageTag: "0.3.5"
      semanticEngine:
        enabled: true
        imageTag: "0.4.0"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].image
          value: "ghcr.io/oxy-hq/oxy-semantic-engine:0.4.0"

  - it: should use custom imagePullPolicy for semantic engine
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
        imagePullPolicy: "Always"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].imagePullPolicy
          value: "Always"

  - it: should configure semantic engine ports correctly
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[1].ports
          content:
            containerPort: 4000
            protocol: TCP
            name: cubejs-port

  - it: should configure semantic engine without custom environment variables
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine
      # Should not have env block - uses container defaults
      - isNull:
          path: spec.template.spec.containers[1].env

  - it: should mount workspace volume in semantic engine
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
        mountPath: "/data"
    asserts:
      - contains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            name: workspace
            mountPath: "/data"

  - it: should use container default CMD and set working directory
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
        mountPath: "/workspace"
    asserts:
      # Should not override command - uses container's built-in script
      - isNull:
          path: spec.template.spec.containers[1].command
      # Should set workingDir to git-synced directory
      - equal:
          path: spec.template.spec.containers[1].workingDir
          value: "/workspace/current"

  - it: should work with git sync and semantic engine and extra sidecars together
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      extraSidecars:
        - name: monitoring
          image: prom/node-exporter:v1.6.0
      persistence:
        enabled: true
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers
          count: 3
      - equal:
          path: spec.template.spec.containers[0].name
          value: oxy-app
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine
      - equal:
          path: spec.template.spec.containers[2].name
          value: monitoring

  - it: should add CUBEJS_API_URL to main container when git sync enabled
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUBEJS_API_URL
            value: "http://localhost:4000"

  - it: should not add CUBEJS_API_URL when git sync disabled
    set:
      gitSync:
        enabled: false
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUBEJS_API_URL

  - it: should set working directory with custom mountPath
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
        link: "repo"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
        mountPath: "/data"
    asserts:
      - equal:
          path: spec.template.spec.containers[1].workingDir
          value: "/data/repo"

  - it: should deploy semantic engine with SSH authentication
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      sshKey:
        privateKey: "fake-key"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine

  - it: should deploy semantic engine with HTTP authentication
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      semanticEngine:
        enabled: true
      httpAuth:
        username: "user"
        password: "pass"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine

  - it: should deploy semantic engine with GitHub App authentication
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      semanticEngine:
        enabled: true
        githubApp:
          privateKey: "pem-key"
          applicationId: "123"
          installationId: "456"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine

  - it: should ensure semantic engine has access to workspace with different persistence settings
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
        mountPath: "/custom/path"
        size: "50Gi"
        storageClassName: "fast-ssd"
    asserts:
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine
      - contains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            name: workspace
            mountPath: "/custom/path"
      - equal:
          path: spec.template.spec.containers[1].workingDir
          value: "/custom/path/current"

  - it: should deploy semantic engine with PostgreSQL subchart
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      database:
        postgres:
          enabled: true
      postgres:
        userDatabase:
          user:
            value: "testuser"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine

  - it: should deploy semantic engine with external database
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      database:
        external:
          enabled: true
          connectionString: "postgresql://user:pass@host:5432/db"
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine

  - it: should ensure semantic engine works with resource limits
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 4Gi
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine
      - equal:
          path: spec.template.spec.containers[1].ports[0].containerPort
          value: 4000

  - it: should ensure CUBEJS_API_URL is set for main container when semantic engine is deployed
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      # Verify semantic engine exists
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine
      # Verify main container has CUBEJS_API_URL
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUBEJS_API_URL
            value: "http://localhost:4000"

  - it: should ensure semantic engine port matches CUBEJS_API_URL port
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      persistence:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[1].ports[0].containerPort
          value: 4000
      - equal:
          path: spec.template.spec.containers[1].ports[0].name
          value: "cubejs-port"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUBEJS_API_URL
            value: "http://localhost:4000"

  - it: should verify semantic engine configuration is complete
    set:
      gitSync:
        enabled: true
        repository: "git@github.com:example/repo.git"
      semanticEngine:
        enabled: true
      app:
        imageTag: "1.0.0"
      persistence:
        enabled: true
        mountPath: "/workspace"
    asserts:
      # Container exists
      - equal:
          path: spec.template.spec.containers[1].name
          value: semantic-engine
      # Image configuration
      - equal:
          path: spec.template.spec.containers[1].image
          value: "ghcr.io/oxy-hq/oxy-semantic-engine:1.0.0"
      - equal:
          path: spec.template.spec.containers[1].imagePullPolicy
          value: "IfNotPresent"
      # Working directory
      - equal:
          path: spec.template.spec.containers[1].workingDir
          value: "/workspace/current"
      # Port configuration
      - contains:
          path: spec.template.spec.containers[1].ports
          content:
            containerPort: 4000
            protocol: TCP
            name: cubejs-port
      # No custom environment variables - uses container defaults
      - isNull:
          path: spec.template.spec.containers[1].env
      # Volume mounts
      - contains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            name: workspace
            mountPath: "/workspace"