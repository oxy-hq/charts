suite: serviceaccount tests
templates:
  - serviceaccount.yaml

tests:
  # Basic ServiceAccount rendering
  - it: should render ServiceAccount with correct metadata
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-oxy-app
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: oxy-app
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  # ServiceAccount disabled
  - it: should not render when disabled
    set:
      serviceAccount:
        create: false
    asserts:
      - hasDocuments:
          count: 0

  # Custom ServiceAccount name
  - it: should support custom name
    set:
      serviceAccount:
        create: true
        name: custom-sa
    asserts:
      - equal:
          path: metadata.name
          value: custom-sa

  # ServiceAccount annotations
  - it: should support annotations
    set:
      serviceAccount:
        create: true
        annotations:
          eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/oxy-role"
          custom.io/annotation: "test-value"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/oxy-role"
      - equal:
          path: metadata.annotations["custom.io/annotation"]
          value: "test-value"

  # Multiple annotations
  - it: should support multiple cloud provider annotations
    set:
      serviceAccount:
        create: true
        annotations:
          eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/oxy-role"
          iam.gke.io/gcp-service-account: "oxy-app@project.iam.gserviceaccount.com"
          azure.workload.identity/client-id: "12345678-1234-1234-1234-123456789012"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789012:role/oxy-role"
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: "oxy-app@project.iam.gserviceaccount.com"
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "12345678-1234-1234-1234-123456789012"