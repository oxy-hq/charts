suite: test http auth secret
templates:
  - http-auth-secret.yaml
tests:
  - it: should not create secret when gitSync is disabled
    set:
      gitSync:
        enabled: false
      httpAuth:
        username: "myuser"
        password: "mypass"
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create secret when httpAuth.password is empty
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      httpAuth:
        username: "myuser"
        password: ""
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create secret when httpAuth.username is empty
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      httpAuth:
        username: ""
        password: "mypass"
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create secret when using secretName reference
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      httpAuth:
        username: "myuser"
        password: "mypass"
        secretName: "existing-secret"
    asserts:
      - hasDocuments:
          count: 0

  - it: should create secret with inline password
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      httpAuth:
        username: "myuser"
        password: "mypass"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-oxy-app-http-auth
      - equal:
          path: type
          value: Opaque
      - equal:
          path: stringData.password
          value: "mypass"

  - it: should create secret with correct namespace
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      httpAuth:
        username: "myuser"
        password: "mypass"
    release:
      namespace: custom-namespace
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-namespace

  - it: should include standard labels
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      httpAuth:
        username: "myuser"
        password: "mypass"
    asserts:
      - isNotEmpty:
          path: metadata.labels
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: oxy-app
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should handle special characters in password
    set:
      gitSync:
        enabled: true
        repository: "https://github.com/example/repo.git"
      httpAuth:
        username: "myuser"
        password: "my!p@ss#w$rd%123"
    asserts:
      - equal:
          path: stringData.password
          value: "my!p@ss#w$rd%123"
