{{/*
Define git sync paths
Per git-sync documentation: when using persistent volumes (especially those at filesystem root),
the --root flag must point to a subdirectory of the volume mount, NOT the mount point itself.
This avoids conflicts with filesystem metadata like 'lost+found' in ext2/3/4 filesystems,
which can cause git-sync to fail or leave directories empty.

We ensure this by treating gitSync.root and gitSync.link as relative directory names that
are always appended to the persistence.mountPath, preventing accidental misconfiguration.
*/}}
{{- $gitRootDir := default "git" .Values.gitSync.root -}}
{{- $gitLinkDir := default "current" .Values.gitSync.link -}}
{{- $gitRoot := printf "%s/%s" .Values.persistence.mountPath $gitRootDir -}}
{{- $gitLink := printf "%s/%s" .Values.persistence.mountPath $gitLinkDir -}}
{{- $workingDir := $gitLink -}}
{{- if and .Values.gitSync.workingDir (ne .Values.gitSync.workingDir "") -}}
  {{- $workingDir = printf "%s/%s" $gitLink .Values.gitSync.workingDir -}}
{{- end -}}

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "oxy-app.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "oxy-app.labels" . | nindent 4 }}
    version: v1
spec:
  serviceName: {{ include "oxy-app.fullname" . }}-headless
  replicas: {{ .Values.app.replicaCount }}
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0
  selector:
    matchLabels:
      {{- include "oxy-app.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "oxy-app.selectorLabels" . | nindent 8 }}
        version: v1
      {{- if .Values.otelCollector.enabled }}
      annotations:
        checksum/otel-config: {{ include (print $.Template.BasePath "/otel-configmap.yaml") . | sha256sum }}
      {{- end }}
    spec:
      {{- $sa := include "oxy-app.serviceAccountName" . }}
      {{- if ne $sa "" }}
      serviceAccountName: {{ $sa | quote }}
      {{- end }}
      securityContext:
        fsGroup: {{ .Values.securityContext.fsGroup }}

      {{- if or .Values.gitSync.enabled .Values.database.postgres.enabled .Values.database.clickhouse.enabled .Values.extraInitContainers }}
      initContainers:
        {{- if .Values.database.postgres.enabled }}
        # Wait for PostgreSQL to be ready
        - name: wait-for-postgres
          image: postgres:16-alpine
          command: ['sh', '-c']
          args:
            - |
              echo "Waiting for PostgreSQL to be ready..."
              {{- if .Values.postgres.fullnameOverride }}
              PG_HOST="{{ .Values.postgres.fullnameOverride }}.{{ .Release.Namespace }}.svc.cluster.local"
              {{- else if .Values.database.postgres.host }}
              PG_HOST="{{ .Values.database.postgres.host }}"
              {{- else }}
              PG_HOST="{{ .Release.Name }}-postgres.{{ .Release.Namespace }}.svc.cluster.local"
              {{- end }}
              PG_PORT="{{ .Values.database.postgres.port }}"
              MAX_RETRIES=60
              RETRY_COUNT=0
              
              echo "Target: $PG_HOST:$PG_PORT"
              
              # First, check DNS resolution
              echo "Checking DNS resolution..."
              while [ $RETRY_COUNT -lt 10 ]; do
                if nslookup "$PG_HOST" >/dev/null 2>&1; then
                  echo "DNS resolution successful for $PG_HOST"
                  break
                fi
                echo "DNS lookup failed, retrying in 2 seconds... ($RETRY_COUNT/10)"
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 2
              done
              
              # Reset counter for pg_isready check
              RETRY_COUNT=0
              
              # Now check PostgreSQL readiness
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if pg_isready -h "$PG_HOST" -p "$PG_PORT" -t 5; then
                  echo "PostgreSQL is ready and accepting connections!"
                  exit 0
                fi
                echo "PostgreSQL is not ready yet. Waiting 5 seconds... ($RETRY_COUNT/$MAX_RETRIES)"
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 5
              done
              
              echo "ERROR: PostgreSQL did not become ready within the timeout period"
              exit 1
        {{- end }}
        {{- if .Values.database.clickhouse.enabled }}
        # Wait for ClickHouse to be ready
        - name: wait-for-clickhouse
          image: curlimages/curl:8.5.0
          command: ['sh', '-c']
          args:
            - |
              echo "Waiting for ClickHouse to be ready..."
              {{- if .Values.clickhouseSubchart.fullnameOverride }}
              CH_HOST="{{ .Values.clickhouseSubchart.fullnameOverride }}.{{ .Release.Namespace }}.svc.cluster.local"
              {{- else if .Values.database.clickhouse.host }}
              CH_HOST="{{ .Values.database.clickhouse.host }}"
              {{- else }}
              CH_HOST="{{ .Release.Name }}-clickhouse.{{ .Release.Namespace }}.svc.cluster.local"
              {{- end }}
              CH_PORT="{{ .Values.database.clickhouse.httpPort }}"
              MAX_RETRIES=60
              RETRY_COUNT=0

              echo "Target: $CH_HOST:$CH_PORT"

              # First, check DNS resolution
              echo "Checking DNS resolution..."
              while [ $RETRY_COUNT -lt 10 ]; do
                if nslookup "$CH_HOST" >/dev/null 2>&1; then
                  echo "DNS resolution successful for $CH_HOST"
                  break
                fi
                echo "DNS lookup failed, retrying in 2 seconds... ($RETRY_COUNT/10)"
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 2
              done

              # Reset counter for ClickHouse health check
              RETRY_COUNT=0

              # Now check ClickHouse readiness via HTTP ping endpoint
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if curl -sf "http://$CH_HOST:$CH_PORT/ping" >/dev/null 2>&1; then
                  echo "ClickHouse is ready and accepting connections!"
                  exit 0
                fi
                echo "ClickHouse is not ready yet. Waiting 5 seconds... ($RETRY_COUNT/$MAX_RETRIES)"
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 5
              done

              echo "ERROR: ClickHouse did not become ready within the timeout period"
              exit 1
        {{- end }}
        {{- if .Values.gitSync.enabled }}
        # Git Clone Init Container
        # One-time secure clone using kubernetes/git-sync. This creates a
        # linked copy at /workspace/current that the long-running git-sync
        # sidecar will keep up-to-date.
        - name: git-clone
          image: k8s.gcr.io/git-sync/git-sync:v4.4.3
          imagePullPolicy: {{ .Values.gitSync.imagePullPolicy }}
          args:
            - --repo={{ .Values.gitSync.repository }}
            - --branch={{ .Values.gitSync.branch }}
            - --root={{ $gitRoot }}
            - --link={{ $gitLink }}
            - --one-time=true
            - --depth=1
            {{- if .Values.httpAuth.username }}
            {{- /* HTTP authentication */}}
            - --username={{ .Values.httpAuth.username }}
            - --password-file=/etc/git-auth/password
            {{- else if or .Values.gitSync.githubApp.secretName (and .Values.gitSync.githubApp.privateKey .Values.gitSync.githubApp.applicationId .Values.gitSync.githubApp.installationId) }}
            {{- /* GitHub App authentication: use private key file arg + env vars for IDs and base URL */}}
            - --github-app-private-key-file=/etc/github-app/{{ .Values.gitSync.githubApp.privateKeyKey }}
            {{- else if .Values.sshKey.privateKey }}
            - --ssh-key-file=/etc/git-secret/ssh
            {{- if .Values.sshKey.knownHosts }}
            - --ssh-known-hosts-file=/etc/git-secret/known_hosts
            {{- end }}
            {{- else }}
            {{- /* No auth provided; rely on externally managed secrets or disabled gitSync */}}
            {{- end }}
            - --max-failures=5
            - --verbose=1
            - --one-time
            - --git-gc=off
          env:
            {{- if .Values.gitSync.githubApp.secretName }}
            - name: GITSYNC_GITHUB_APP_APPLICATION_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.gitSync.githubApp.secretName }}
                  key: {{ .Values.gitSync.githubApp.applicationIdKey }}
            - name: GITSYNC_GITHUB_APP_INSTALLATION_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.gitSync.githubApp.secretName }}
                  key: {{ .Values.gitSync.githubApp.installationIdKey }}
            {{- else }}
            {{- if .Values.gitSync.githubApp.applicationId }}
            - name: GITSYNC_GITHUB_APP_APPLICATION_ID
              value: {{ .Values.gitSync.githubApp.applicationId | quote }}
            {{- end }}
            {{- if .Values.gitSync.githubApp.installationId }}
            - name: GITSYNC_GITHUB_APP_INSTALLATION_ID
              value: {{ .Values.gitSync.githubApp.installationId | quote }}
            {{- end }}
            {{- end }}
          volumeMounts:
            - name: workspace
              mountPath: {{ .Values.persistence.mountPath }}
            {{- if .Values.httpAuth.username }}
            {{- /* HTTP authentication */}}
            - name: git-http-auth
              mountPath: /etc/git-auth
              readOnly: true
            {{- else if or .Values.gitSync.githubApp.secretName (and .Values.gitSync.githubApp.privateKey .Values.gitSync.githubApp.applicationId .Values.gitSync.githubApp.installationId) }}
            {{- /* Mount GitHub App secret (either user-provided or chart-created) */}}
            - name: github-app-secret
              mountPath: /etc/github-app
              readOnly: true
            {{- else if .Values.sshKey.privateKey }}
            {{- /* Single SSH key mount */}}
            - name: git-ssh
              mountPath: /etc/git-secret
              readOnly: true
            {{- end }}
        {{- end }}

        {{- /* Render any user-supplied init containers */}}
        {{- with .Values.extraInitContainers }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- end }}

      containers:
        # Main Application Container
        - name: {{ include "oxy-app.name" . }}
          image: "{{ .Values.app.image }}:{{ default .Chart.AppVersion .Values.app.imageTag }}"
          {{- if and .Values.app.command (gt (len .Values.app.command) 0) }}
          command:
            {{- range .Values.app.command }}
            - {{ . | quote }}
            {{- end }}
          {{- else }}
          command:
            - sh
            - -c
            - |
              exec oxy serve{{- if not .Values.gitSync.enabled }} --cloud{{- end }}
          {{- end }}
          {{- if .Values.gitSync.enabled }}
          workingDir: {{ $workingDir }}
          {{- end }}
          ports:
            - containerPort: {{ .Values.app.port }}
              protocol: TCP
              name: traffic-port

          # Environment Variables
          env:
            # State Directory Configuration
            {{- if and .Values.env.OXY_STATE_DIR (ne .Values.env.OXY_STATE_DIR "") }}
            - name: OXY_STATE_DIR
              value: {{ .Values.env.OXY_STATE_DIR | quote }}
            {{- else }}
            - name: OXY_STATE_DIR
              value: {{ printf "%s/%s" .Values.persistence.mountPath .Values.persistence.folder | quote }}
            {{- end }}

            # Database URL Configuration
            # Preference order (sqlite fallback intentionally omitted):
            # 1) Explicit value provided by caller via values.env.OXY_DATABASE_URL
            # 2) Explicit external.connectionString or external fields
            # 3) Postgres subchart connection (if user enabled it manually)
            # If none are provided, OXY_DATABASE_URL will not be set
            {{- if and .Values.env.OXY_DATABASE_URL (ne .Values.env.OXY_DATABASE_URL "") }}
            - name: OXY_DATABASE_URL
              value: {{ .Values.env.OXY_DATABASE_URL | quote }}
            {{- else if and .Values.database.external.enabled (ne .Values.database.external.connectionString "") }}
            - name: OXY_DATABASE_URL
              value: {{ .Values.database.external.connectionString | quote }}
            {{- else if .Values.database.external.enabled }}
            - name: OXY_DATABASE_URL
              value: {{ printf "postgresql://%s:%s@%s:%v/%s" 
                .Values.database.external.user 
                .Values.database.external.password 
                .Values.database.external.host 
                .Values.database.external.port 
                .Values.database.external.database | quote }}
            {{- else if .Values.database.postgres.enabled }}
            - name: OXY_DATABASE_URL
              {{- $pgHost := "" }}
              {{- if .Values.postgres.fullnameOverride }}
                {{- $pgHost = printf "%s.%s.svc.cluster.local" .Values.postgres.fullnameOverride .Release.Namespace }}
              {{- else if .Values.database.postgres.host }}
                {{- $pgHost = .Values.database.postgres.host }}
              {{- else }}
                {{- $pgHost = printf "%s-postgres.%s.svc.cluster.local" .Release.Name .Release.Namespace }}
              {{- end }}
              value: {{ printf "postgresql://%s:%s@%s:%v/%s"
                (default "postgres" .Values.postgres.userDatabase.user.value)
                (default "postgres" .Values.postgres.userDatabase.password.value)
                $pgHost
                .Values.database.postgres.port
                (default "postgres" .Values.postgres.userDatabase.name.value) | quote }}
            {{- end }}

            # Additional environment variables from values.env
            {{- range $key, $value := .Values.env }}
            {{- if and (ne $key "OXY_STATE_DIR") (ne $key "OXY_DATABASE_URL") }}
            {{- if ne $value "" }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
            {{- end }}
            {{- end }}

            # Semantic Engine API URL (when gitSync and semanticEngine are enabled)
            {{- if and .Values.gitSync.enabled .Values.semanticEngine.enabled }}
            - name: CUBEJS_API_URL
              value: "http://localhost:4000"
            {{- end }}

            # ClickHouse Configuration
            # Preference order:
            # 1) Embedded subchart (database.clickhouse.enabled = true)
            # 2) External ClickHouse (clickhouse.enabled = true, database.clickhouse.enabled = false)
            {{- if .Values.database.clickhouse.enabled }}
            {{- $chHost := "" }}
            {{- if .Values.clickhouseSubchart.fullnameOverride }}
              {{- $chHost = printf "%s.%s.svc.cluster.local" .Values.clickhouseSubchart.fullnameOverride .Release.Namespace }}
            {{- else if .Values.database.clickhouse.host }}
              {{- $chHost = .Values.database.clickhouse.host }}
            {{- else }}
              {{- $chHost = printf "%s-clickhouse.%s.svc.cluster.local" .Release.Name .Release.Namespace }}
            {{- end }}
            - name: OXY_CLICKHOUSE_URL
              value: {{ printf "http://%s:%v" $chHost (.Values.database.clickhouse.httpPort | default 8123) | quote }}
            - name: OXY_CLICKHOUSE_DATABASE
              value: {{ .Values.clickhouse.database | default "default" | quote }}
            {{- if .Values.clickhouseSubchart.auth.existingSecret }}
            - name: OXY_CLICKHOUSE_USER
              value: {{ .Values.clickhouseSubchart.auth.username | default "default" | quote }}
            - name: OXY_CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.clickhouseSubchart.auth.existingSecret }}
                  key: {{ .Values.clickhouseSubchart.auth.existingSecretPasswordKey | default "password" }}
            {{- else }}
            - name: OXY_CLICKHOUSE_USER
              value: {{ .Values.clickhouseSubchart.auth.username | default "default" | quote }}
            - name: OXY_CLICKHOUSE_PASSWORD
              value: {{ .Values.clickhouseSubchart.auth.password | default "" | quote }}
            {{- end }}
            {{- else if .Values.clickhouse.enabled }}
            - name: OXY_CLICKHOUSE_URL
              value: {{ .Values.clickhouse.url | quote }}
            - name: OXY_CLICKHOUSE_DATABASE
              value: {{ .Values.clickhouse.database | quote }}
            {{- if and .Values.clickhouse.existingSecret .Values.clickhouse.existingSecret.name }}
            - name: OXY_CLICKHOUSE_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.clickhouse.existingSecret.name }}
                  key: {{ default "username" .Values.clickhouse.existingSecret.usernameKey }}
            - name: OXY_CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.clickhouse.existingSecret.name }}
                  key: {{ default "password" .Values.clickhouse.existingSecret.passwordKey }}
            {{- else }}
            - name: OXY_CLICKHOUSE_USER
              value: {{ .Values.clickhouse.username | quote }}
            - name: OXY_CLICKHOUSE_PASSWORD
              value: {{ .Values.clickhouse.password | quote }}
            {{- end }}
            {{- end }}

          # ConfigMap / Secret Environment Variables
          {{- if or .Values.configMap.enabled (gt (len .Values.externalSecrets.envSecretNames) 0) }}
          envFrom:
            {{- if .Values.configMap.enabled }}
            - configMapRef:
                name: {{ include "oxy-app.fullname" . }}-config
            {{- end }}
            {{- range .Values.externalSecrets.envSecretNames }}
            - secretRef:
                name: {{ . | quote }}
            {{- end }}
          {{- end }}

          # Resource Limits and Requests
          {{- with .Values.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}

          # Volume Mounts
          volumeMounts:
            - name: workspace
              mountPath: {{ .Values.persistence.mountPath }}
            {{- /* Mount environment secrets */}}
            {{- range $idx, $secretName := .Values.externalSecrets.envSecretNames }}
            - name: env-secret-{{ $idx }}
              mountPath: /secrets/env/{{ $secretName }}
              readOnly: true
            {{- end }}
            {{- /* Mount file secrets */}}
            {{- range $idx, $fileSecret := .Values.externalSecrets.fileSecrets }}
            - name: file-secret-{{ $idx }}
              mountPath: /secrets/files/{{ $fileSecret.name }}
              readOnly: true
            {{- end }}

          # Health Checks
          {{- with .Values.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}

        {{- if and .Values.gitSync.enabled .Values.semanticEngine.enabled }}
        - name: semantic-engine
          image: "{{ .Values.semanticEngine.image }}:{{ default (default .Chart.AppVersion .Values.app.imageTag) .Values.semanticEngine.imageTag }}"
          imagePullPolicy: {{ .Values.semanticEngine.imagePullPolicy }}
          workingDir: {{ $workingDir }}
          ports:
            - containerPort: 4000
              protocol: TCP
              name: cubejs-port
          volumeMounts:
            - name: workspace
              mountPath: {{ .Values.persistence.mountPath }}
        {{- end }}

        {{- if .Values.otelCollector.enabled }}
        - name: otel-collector
          image: "{{ .Values.otelCollector.image }}:{{ .Values.otelCollector.imageTag }}"
          imagePullPolicy: {{ .Values.otelCollector.imagePullPolicy }}
          command:
            - "/otelcol-contrib"
            - "--config=/etc/otelcol/config.yaml"
          ports:
            - containerPort: {{ .Values.otelCollector.ports.otlpGrpc }}
              protocol: TCP
              name: otlp-grpc
            - containerPort: {{ .Values.otelCollector.ports.otlpHttp }}
              protocol: TCP
              name: otlp-http
            - containerPort: {{ .Values.otelCollector.ports.metrics }}
              protocol: TCP
              name: metrics
          {{- if or (and .Values.database.clickhouse.enabled .Values.clickhouseSubchart.auth.existingSecret) (and .Values.clickhouse.existingSecret .Values.clickhouse.existingSecret.name) }}
          env:
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  {{- if and .Values.database.clickhouse.enabled .Values.clickhouseSubchart.auth.existingSecret }}
                  name: {{ .Values.clickhouseSubchart.auth.existingSecret }}
                  key: {{ .Values.clickhouseSubchart.auth.existingSecretPasswordKey | default "password" }}
                  {{- else }}
                  name: {{ .Values.clickhouse.existingSecret.name }}
                  key: {{ default "password" .Values.clickhouse.existingSecret.passwordKey }}
                  {{- end }}
          {{- end }}
          volumeMounts:
            - name: otel-collector-config
              mountPath: /etc/otelcol
              readOnly: true
          {{- with .Values.otelCollector.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          startupProbe:
            httpGet:
              path: /
              port: 13133
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12
          livenessProbe:
            httpGet:
              path: /
              port: 13133
            periodSeconds: 30
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /
              port: 13133
            periodSeconds: 10
            failureThreshold: 3
        {{- end }}

        {{- /* Render user-supplied sidecars after built-in sidecars */}}
        {{- with .Values.extraSidecars }}
        {{- toYaml . | nindent 8 }}
        {{- end }}

      # Volume Definitions
      volumes:
        {{- if .Values.gitSync.enabled }}
        {{- if .Values.httpAuth.username }}
        {{- /* HTTP authentication secret */}}
        {{- $httpAuthSecretName := "" }}
        {{- if .Values.httpAuth.secretName }}
          {{- $httpAuthSecretName = .Values.httpAuth.secretName }}
        {{- else if .Values.httpAuth.password }}
          {{- $httpAuthSecretName = printf "%s-http-auth" (include "oxy-app.fullname" $) }}
        {{- end }}
        - name: git-http-auth
          secret:
            secretName: {{ $httpAuthSecretName }}
            defaultMode: 0400
            optional: false
            items:
              - key: {{ .Values.httpAuth.passwordKey }}
                path: password
        {{- else if or .Values.gitSync.githubApp.secretName (and .Values.gitSync.githubApp.privateKey .Values.gitSync.githubApp.applicationId .Values.gitSync.githubApp.installationId) }}
        {{- /* GitHub App secret: if user provided a secretName, mount entire secret; otherwise chart-created secret mounts only the private key file */}}
        {{- if .Values.gitSync.githubApp.secretName }}
        - name: github-app-secret
          secret:
            secretName: {{ .Values.gitSync.githubApp.secretName }}
            defaultMode: 0400
            optional: false
        {{- else }}
        - name: github-app-secret
          secret:
            secretName: {{ printf "%s-github-app" (include "oxy-app.fullname" $) }}
            defaultMode: 0400
            optional: false
            items:
              - key: {{ .Values.gitSync.githubApp.privateKeyKey }}
                path: {{ .Values.gitSync.githubApp.privateKeyKey }}
        {{- end }}
        {{- else }}
        - name: git-ssh
          secret:
            secretName: {{ default .Values.gitSync.sshSecretName .Values.sshKey.secretName }}
            defaultMode: 0400
            optional: false
        {{- end }}
        {{- end }}
        {{- /* Environment secret volumes */}}
        {{- range $idx, $secretName := .Values.externalSecrets.envSecretNames }}
        - name: env-secret-{{ $idx }}
          secret:
            secretName: {{ $secretName | quote }}
            optional: true
        {{- end }}
        {{- /* File secret volumes */}}
        {{- range $idx, $fileSecret := .Values.externalSecrets.fileSecrets }}
        - name: file-secret-{{ $idx }}
          secret:
            secretName: {{ $fileSecret.name | quote }}
            optional: true
        {{- end }}
        {{- /* OpenTelemetry Collector config volume */}}
        {{- if .Values.otelCollector.enabled }}
        - name: otel-collector-config
          configMap:
            name: {{ include "oxy-app.fullname" . }}-otel-collector
        {{- end }}

      # Node Selection and Tolerations
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}

  # Persistent Volume Claim Templates
  volumeClaimTemplates:
    - metadata:
        name: workspace
        {{- with .Values.persistence.annotations }}
        annotations:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .Values.persistence.labels }}
        labels:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      spec:
        accessModes:
          - {{ .Values.persistence.accessMode | quote }}
        {{- with .Values.persistence.storageClassName }}
        storageClassName: {{ . }}
        {{- end }}
        {{- with .Values.persistence.volumeMode }}
        volumeMode: {{ . }}
        {{- end }}
        {{- with .Values.persistence.selector }}
        selector:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        resources:
          requests:
            storage: {{ .Values.persistence.size }}