{{- if .Values.gitSync.enabled }}

{{- /* Render a single SSH secret if inline keys are provided or a secretName is set */ -}}
{{- if or .Values.sshKey.privateKey .Values.sshKey.secretName }}
{{- $secretName := default .Values.gitSync.sshSecretName .Values.sshKey.secretName }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "oxy-app.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if .Values.sshKey.privateKey }}
  ssh: {{ .Values.sshKey.privateKey | b64enc | quote }}
  {{- end }}
  {{- if .Values.sshKey.knownHosts }}
  known_hosts: {{ .Values.sshKey.knownHosts | b64enc | quote }}
  {{- end }}
{{- end }}

{{- /* Render a secret containing GitHub App credentials if provided. If
      githubApp.secretName is set, we assume the secret exists and do not
      create one. Otherwise create a secret named <fullname>-github-app. */ -}}
{{- if and (not .Values.gitSync.githubApp.secretName) .Values.gitSync.githubApp.privateKey .Values.gitSync.githubApp.applicationId .Values.gitSync.githubApp.installationId }}
{{- $ghSecretName := printf "%s-github-app" (include "oxy-app.fullname" .) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $ghSecretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "oxy-app.labels" . | nindent 4 }}
type: Opaque
data:
  {{ .Values.gitSync.githubApp.privateKeyKey | quote }}: {{ .Values.gitSync.githubApp.privateKey | b64enc | quote }}
  {{ .Values.gitSync.githubApp.applicationIdKey | quote }}: {{ printf "%v" .Values.gitSync.githubApp.applicationId | b64enc | quote }}
  {{ .Values.gitSync.githubApp.installationIdKey | quote }}: {{ printf "%v" .Values.gitSync.githubApp.installationId | b64enc | quote }}
  {{- if .Values.gitSync.githubApp.clientId }}
  {{ .Values.gitSync.githubApp.clientIdKey | quote }}: {{ printf "%v" .Values.gitSync.githubApp.clientId | b64enc | quote }}
  {{- end }}
  {{- if and .Values.gitSync.githubApp.baseUrl (ne .Values.gitSync.githubApp.baseUrl "https://api.github.com") }}
  {{ .Values.gitSync.githubApp.baseUrlKey | quote }}: {{ printf "%v" .Values.gitSync.githubApp.baseUrl | b64enc | quote }}
  {{- end }}
{{- end }}

{{- end }}
