{{- if .Values.otelCollector.enabled }}
{{- /*
  Resolve ClickHouse settings with fallback to shared config:
  - otelCollector.clickhouse.* overrides take precedence
  - Falls back to shared clickhouse.* config
  - For embedded subchart (database.clickhouse.enabled), auto-derive endpoints
  - For TCP endpoint: can derive from HTTP URL if tcpEndpoint not set
*/ -}}
{{- $chEndpoint := .Values.otelCollector.clickhouse.endpoint -}}
{{- $chDatabase := "" -}}
{{- $chUsername := "" -}}
{{- $chPassword := "" -}}
{{- $useSecret := false -}}

{{- if not $chEndpoint -}}
  {{- if .Values.database.clickhouse.enabled -}}
    {{- /* Using embedded ClickHouse subchart - derive TCP endpoint */ -}}
    {{- $chHost := "" -}}
    {{- if .Values.clickhouseSubchart.fullnameOverride -}}
      {{- $chHost = printf "%s.%s.svc.cluster.local" .Values.clickhouseSubchart.fullnameOverride $.Release.Namespace -}}
    {{- else if .Values.database.clickhouse.host -}}
      {{- $chHost = .Values.database.clickhouse.host -}}
    {{- else -}}
      {{- $chHost = printf "%s-clickhouse.%s.svc.cluster.local" $.Release.Name $.Release.Namespace -}}
    {{- end -}}
    {{- $chTcpPort := .Values.database.clickhouse.tcpPort | default 9000 -}}
    {{- $chEndpoint = printf "tcp://%s:%v" $chHost $chTcpPort -}}
  {{- else if .Values.clickhouse.tcpEndpoint -}}
    {{- $chEndpoint = .Values.clickhouse.tcpEndpoint -}}
  {{- else if .Values.clickhouse.url -}}
    {{- /* Derive TCP endpoint from HTTP URL: http://host:8123 -> tcp://host:9000 */ -}}
    {{- $chEndpoint = .Values.clickhouse.url | replace "http://" "tcp://" | replace "https://" "tcp://" | replace ":8123" ":9000" -}}
  {{- end -}}
{{- end -}}

{{- /* Resolve credentials based on subchart or external config */ -}}
{{- if .Values.database.clickhouse.enabled -}}
  {{- /* Using embedded subchart */ -}}
  {{- $chDatabase = default "default" (default .Values.clickhouse.database .Values.otelCollector.clickhouse.database) -}}
  {{- $chUsername = default "default" (default .Values.clickhouseSubchart.auth.username .Values.otelCollector.clickhouse.username) -}}
  {{- if .Values.clickhouseSubchart.auth.existingSecret -}}
    {{- $useSecret = true -}}
  {{- else -}}
    {{- $chPassword = default "" (default .Values.clickhouseSubchart.auth.password .Values.otelCollector.clickhouse.password) -}}
  {{- end -}}
{{- else -}}
  {{- /* Using external ClickHouse */ -}}
  {{- $chDatabase = default .Values.clickhouse.database .Values.otelCollector.clickhouse.database -}}
  {{- $chUsername = default .Values.clickhouse.username .Values.otelCollector.clickhouse.username -}}
  {{- $chPassword = default .Values.clickhouse.password .Values.otelCollector.clickhouse.password -}}
  {{- if and .Values.clickhouse.existingSecret .Values.clickhouse.existingSecret.name -}}
    {{- $useSecret = true -}}
  {{- end -}}
{{- end -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "oxy-app.fullname" . }}-otel-collector
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "oxy-app.labels" . | nindent 4 }}
data:
  config.yaml: |
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:{{ .Values.otelCollector.ports.otlpGrpc }}
          http:
            endpoint: 0.0.0.0:{{ .Values.otelCollector.ports.otlpHttp }}

    processors:
      batch:
        timeout: {{ .Values.otelCollector.processors.batch.timeout }}
        send_batch_size: {{ .Values.otelCollector.processors.batch.sendBatchSize }}
        send_batch_max_size: {{ .Values.otelCollector.processors.batch.sendBatchMaxSize }}
      memory_limiter:
        check_interval: {{ .Values.otelCollector.processors.memoryLimiter.checkInterval }}
        limit_mib: {{ .Values.otelCollector.processors.memoryLimiter.limitMib }}

    exporters:
      {{- if .Values.otelCollector.clickhouse.enabled }}
      clickhouse:
        endpoint: {{ $chEndpoint }}?dial_timeout=10s
        database: {{ $chDatabase }}
        username: {{ $chUsername }}
        {{- if $useSecret }}
        password: ${CLICKHOUSE_PASSWORD}
        {{- else }}
        password: {{ $chPassword | quote }}
        {{- end }}
        async_insert: {{ .Values.otelCollector.clickhouse.asyncInsert }}
        ttl: {{ .Values.otelCollector.clickhouse.ttl }}
        compress: {{ .Values.otelCollector.clickhouse.compress }}
        create_schema: {{ .Values.otelCollector.clickhouse.createSchema }}
        logs_table_name: {{ .Values.otelCollector.clickhouse.logsTableName }}
        traces_table_name: {{ .Values.otelCollector.clickhouse.tracesTableName }}
        metrics_table_name: {{ .Values.otelCollector.clickhouse.metricsTableName }}
        timeout: {{ .Values.otelCollector.clickhouse.timeout }}
        retry_on_failure:
          enabled: {{ .Values.otelCollector.clickhouse.retry.enabled }}
          initial_interval: {{ .Values.otelCollector.clickhouse.retry.initialInterval }}
          max_interval: {{ .Values.otelCollector.clickhouse.retry.maxInterval }}
          max_elapsed_time: {{ .Values.otelCollector.clickhouse.retry.maxElapsedTime }}
      {{- end }}
      {{- if .Values.otelCollector.debug.enabled }}
      debug:
        verbosity: {{ .Values.otelCollector.debug.verbosity }}
      {{- end }}

    service:
      extensions: [health_check]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters:
            {{- if .Values.otelCollector.clickhouse.enabled }}
            - clickhouse
            {{- end }}
            {{- if .Values.otelCollector.debug.enabled }}
            - debug
            {{- end }}
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters:
            {{- if .Values.otelCollector.clickhouse.enabled }}
            - clickhouse
            {{- end }}
            {{- if .Values.otelCollector.debug.enabled }}
            - debug
            {{- end }}
        logs:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters:
            {{- if .Values.otelCollector.clickhouse.enabled }}
            - clickhouse
            {{- end }}
            {{- if .Values.otelCollector.debug.enabled }}
            - debug
            {{- end }}

      telemetry:
        logs:
          level: {{ .Values.otelCollector.telemetry.logs.level }}
{{- end }}
